---
title: "网络通信"
date: 2021-06-30T16:32:22+08:00
---

### 网络通信
#### 七层网络模型
![image](https://user-images.githubusercontent.com/34566156/153376551-696d4c45-7e30-4dbb-952d-27ec8421e5e9.png)
- 应用层
    - HTTP FTP SSH 等等
- 表示层
- 会话层
- 传输层
    - TCP UDP RTP
- 网络层
    - IP ICMP
- 数据链路层
    - 以太网
- 物理层

#### TCP / UDP
![1321644484790_ pic](https://user-images.githubusercontent.com/34566156/153376427-5756fd1a-dbf6-435f-9937-51f6abed8be5.jpg)

TCP建立连接三次握手

- 第一次握手：建立连接。客户端发送连接请求报文段 SYN seq=x 客户端进入SYN_SEND状态 等待服务器的确认
- 第二次握手：服务器收到客户端的SYN请求报文段 确认请求 ACK=x+1 服务器将上述信息放入报文段发给客户端 服务器进入SYN_RECV状态
- 第三次握手：客户端收到服务器的SYN+ACK报文段 将ACK=y+1 像服务器发送报文段 客户端和服务端都进入ESTABLISHED状态

TCP断开连接四次分手

- 第一次分手：主机1 发送FIN报文段seq=x+2 ACK=y+1 主机1进入FIN_WAIT_1 表明主机1没有数据要发送给主机2了
- 第二次分手：主机2收到主机1发送的FIN报文段，发送报文段ACK=x+3 主机1进入FIN_WAIT_2状态 表示主机2同意主机1的关闭请求
- 第三次分手：主机2向主机1发送FIN报文段seq=y+1 请求关闭连接，同时主机2进入LAST_ACK
- 第四次分手：主机1收到主机2发送的FIN报文段 向主机2发送ACK报文段ACK=y+2 主机1进入TIME_WAIT状态 主机2收到主机1的ACK报文段以后就关闭连接 此时，主机1等待2MSL后依然没有收到回复，则证明Server端已正常关闭，那好，主机1也可以关闭连接了

UDP

- UDP不是面向连接的，UDP传送数据前并不与对方建立连接，对接收到的数据也不发送确认信号，发送端不知道数据是否会正确接收，当然也不用重发，所以说UDP是无连接的、不可靠的一种数据传输协议
- UDP的开销更小数据传输速率更高，因为不必进行收发数据的确认，所以UDP的实时性更好。知道了TCP和UDP的区别，就不难理解为何采用TCP传输协议的MSN比采用UDP的QQ传输文件慢了，但并不能说QQ的通信是不安全的，因为程序员可以手动对UDP的数据收发进行验证，比如发送方对每个数据包进行编号然后由接收方进行验证啊什么的，即使是这样，UDP因为在底层协议的封装上没有采用类似TCP的“三次握手”而实现了TCP所无法达到的传输效率

## 通信加密

### 对称加密

对称加密 加密解密使用同一密钥

优点：运算速度快

缺点：无法安全的将密钥传输给通信方

### 非对称加密

非对称密钥加密 公开密钥加密 加密和解密使用不同的密钥

公共密钥所有人都可以获得，通信发送方获得接收方的公开密钥之后，就可以使用公开密钥进行加密 接收方收到通信内容后使用私有密钥解密

优点：可以安全地将公开密钥传输到通信发送方

缺点：运算速度慢

## https加密原理

### 为什么要加密

因为http的内容是明文传输的 中间会经过中间代理服务器 路由器 wifi热点 通信服务运营商等多个物理节点 如果被劫持传输的内容就完全暴露了 而且还有可能被篡改数据 所以需要进行加密

### https 采用非对称加密+对称加密的方式

浏览器请求服务器 服务器把公钥明文发送给浏览器

浏览器随机生成一个用于对称加密的密钥X 用公钥加密后发送给服务器

服务器使用私钥获得密钥X 使用对称加密方式通信

# Q&A

- TCP服务器最大的并发连接

受限于linux可打开文件数

- 为什么TIME_WAIT状态还需要等2MSL后才能返回到CLOSED状态

这是因为虽然双方都同意关闭连接了，而且握手的4个报文也都协调和发送完毕，按理可以直接回到CLOSED状态（就好比从`SYN_SEND`状态到`ESTABLISH`状态那样）；但是因为我们必须要假想网络是不可靠的，你无法保证你最后发送的ACK报文会一定被对方收到，因此对方处于`LAST_ACK`状态下的`Socket`可能会因为超时未收到`ACK`报文，而重发`FIN`报文，所以这个`TIME_WAIT`状态的作用就是用来重发可能丢失的`ACK`报文。
